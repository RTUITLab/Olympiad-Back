@page "/challenges/{ChallengeId:guid}/exercises/{ExerciseId:guid}"
@attribute [Authorize(Roles = RoleNames.ADMIN)]

@using PublicAPI.Responses.Challenges
@using Olympiad.Shared.Models
@using PublicAPI.Responses.Exercises

@inject IChallengesApi ChallengesApi
@inject IExercisesApi ExercisesApi
@inject MessageService MessageService
@inject NavigationManager NavigationManager

<PageTitle>@ChallengeName | Задания</PageTitle>
<PageHeader Title="Задания" Subtitle="@ChallengeName">
    <PageHeaderBreadcrumb>
        <Breadcrumb>
            <BreadcrumbItem Href="challenges">
                Соревнования
            </BreadcrumbItem>
            <BreadcrumbItem Href="@($"challenges/{ChallengeId}")">
                @ChallengeName
            </BreadcrumbItem>
            <BreadcrumbItem Href="@($"challenges/{ChallengeId}/exercises")">
                Задания
            </BreadcrumbItem>
        </Breadcrumb>
    </PageHeaderBreadcrumb>
</PageHeader>

@*
<Table DataSource="exercisesResponse"
       Loading="@(exercisesResponse == null)"
       PageSize="@(exercisesResponse?.Count ?? 0)"
       Total="@(exercisesResponse?.Count ?? 0)"
       HidePagination
       Context="exercise">
    <Column @bind-Field="exercise.Name" Title="Название" Sortable></Column>
    <Column @bind-Field="exercise.TestCasesCount" Sortable>
        <TitleTemplate>
            <Text>Тесты</Text>
            <HelpTooltip>Количество тестов для задания</HelpTooltip>
        </TitleTemplate>
        <ChildContent>
            @if (exercise.TestCasesCount == 0)
            {
                <Alert Type="@AlertType.Error" Message="Не представлено тестов для проверки"/>
            }
            else if (exercise.TestCasesCount < 2)
            {
                <Alert Type="@AlertType.Warning" Message="@($"Мало тестов для проверки ({exercise.TestCasesCount})")"/>
            }
            else
            {
                @exercise.TestCasesCount
            }
        </ChildContent>
    </Column>
    <Column @bind-Field="exercise.Score" Title="Баллы" Sortable></Column>
</Table>*@

@code {
    [Parameter]
    public Guid ChallengeId { get; set; }
    [Parameter]
    public Guid ExerciseId { get; set; }
    private string ChallengeName => challengeResponse?.Name ?? "Загрузка...";

    private ChallengeResponse? challengeResponse;
    private ExerciseInfo? exerciseResponse;
    protected override async Task OnParametersSetAsync()
    {
        await base.OnParametersSetAsync();
        try
        {
            challengeResponse = await ChallengesApi.GetChallengeAsync(ChallengeId);
        }
        catch
        {
            GoToExercisesPage();
            await MessageService.Warn("Соревнование не найдено");
        }
        try
        {
            //exerciseResponse = await ExercisesApi.GetExercisesWithTestsAsync(ChallengeId)
        }
        catch
        {
            GoToExercisesPage();
            await MessageService.Warn("Не удалось получить список заданий");
        }
    }

    private void GoToExercisesPage()
    {
        NavigationManager.NavigateTo($"challenges/{ChallengeId}/exercises");
    }
}
